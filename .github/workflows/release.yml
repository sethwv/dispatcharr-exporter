name: Build and Release Plugin

on:
  release:
    types: [published, released]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Determine version
        id: version
        run: |
          # Check if this is a tag
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="$TAG"
            IS_RELEASE="true"
            # Check if prerelease by looking for existing release
            PRERELEASE=$(gh api repos/${{ github.repository }}/releases/tags/$TAG --jq '.prerelease' 2>/dev/null || echo "false")
            # If tag starts with 'v', strip it; otherwise prefix with dash
            if [[ "$VERSION" == v* ]]; then
              VERSION="${VERSION#v}"
            else
              VERSION="-${VERSION}"
            fi
            if [ "$PRERELEASE" = "true" ]; then
              VERSION="${VERSION}-pre"
            fi
            echo "TAG=$TAG" >> $GITHUB_OUTPUT
          else
            # Not a tag, use branch-hash-timestamp format with dash prefix
            BRANCH="${GITHUB_REF#refs/heads/}"
            BRANCH="${BRANCH//\//-}"  # Replace slashes with dashes
            HASH=$(git rev-parse --short=8 HEAD)
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            VERSION="-${BRANCH}-${HASH}-${TIMESTAMP}"
            IS_RELEASE="false"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "IS_RELEASE=$IS_RELEASE" >> $GITHUB_OUTPUT
          echo "Plugin version: $VERSION"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Update version in plugin.py
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src/plugin.py
          
      - name: Package plugin
        run: |
          chmod +x package.sh
          ./package.sh
      
      - name: Prepare artifact directory
        run: |
          mkdir -p artifact-upload
          # Copy the plugin directory for artifact
          cp -r src artifact-upload/dispatcharr_exporter
      
      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: dispatcharr-exporter${{ steps.version.outputs.VERSION }}
          path: artifact-upload/dispatcharr_exporter
      
      - name: Upload to release
        if: steps.version.outputs.IS_RELEASE == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          TAG="${{ steps.version.outputs.TAG }}"
          
          # Upload the new version (clobber will fail gracefully on immutable releases)
          if ! gh release upload "$TAG" dispatcharr-exporter-${VERSION}.zip --clobber 2>&1; then
            echo "Warning: Upload failed (release may be immutable or asset already exists)"
            # Check if asset exists - if so, we're done
            if gh release view "$TAG" --json assets --jq ".assets[].name" | grep -q "dispatcharr-exporter-${VERSION}.zip"; then
              echo "Asset already exists, continuing..."
            else
              echo "Error: Upload failed and asset doesn't exist"
              exit 1
            fi
          fi
          
          # If this is not a prerelease, remove any old -pre version
          # (will fail gracefully on immutable releases)
          if [[ "$VERSION" != *"-pre"* ]]; then
            PRE_VERSION="${VERSION}-pre"
            echo "Attempting to remove old prerelease asset: dispatcharr-exporter-${PRE_VERSION}.zip"
            gh release delete-asset "$TAG" "dispatcharr-exporter-${PRE_VERSION}.zip" 2>/dev/null || echo "Could not remove prerelease asset (may not exist or releases may be immutable)"
          fi
